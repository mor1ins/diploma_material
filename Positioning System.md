# Позиционирование

Программное обеспечение написано языке сценариев Matlab для обработки изображений и выполнения расчетов. Весь процесс эксперимента схематично показан на блок-схеме.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image004.jpg)

​																		**Этапы эксперимента**

## Подготовка изображения

Фрагмент изображения бумаги с напечатанным шаблоном показан на рисунке.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image005.jpg)

​									**Фрагмент изображения, показывающий массив точек 6×6**

Количество точек, содержащихся в массиве, является минимальным для достаточного количества информации, чтобы идентифицировать позицию при декодировании. Но типичное изображение, полученное камерой, может иметь гораздо больше точек, как показано на рисунке 5-4. Черные кривые - это какой-то рукописный текст. Можно видеть, что шаг сетки точечного рисунка немного меньше ширины надписи.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image006.jpg)

​									 **Figure 5-4 Типичное изображение, полученное камерой**

## Обработка

После того, как изображение получено, следующим шагом является его предобработка для подготовки к процессу декодирования. Данный процесс состоит из преобразования в полутоновое изображение, установки порогового значения, удаления шума и преобразования в черно-белое изображение. Эти процессы могут быть выполнены автоматически с использованием серии пакетных сценариев , которые можно применять ко многим изображениям одновременно. Эти четыре процесса показаны на рисунке 5-5.



![img](file:////Users/mor1ins/projects/diploma/img/clip_image008.jpg)

​																		**Шаги предобработки**

## Декодирование

Изображение, показанное на рис. 5-6 (е), готово к декодированию. Во-первых, каждый BLOB-объект в предварительно обработанном изображении идентифицируется с использованием сценариев Matlab [27,28]. Затем капли будут заменены своими собственными центроидами или центром тяжести. Координаты этих центроидов получены в пикселях. Используя эти координаты, получается новое изображение, содержащее точки только одного пикселя, как показано на рисунке 5-6 (а).

<img src="file:////Users/mor1ins/projects/diploma/img/clip_image010.jpg" alt="img" style="zoom: 200%;" />

 																**(a)**                             **(b)**

 **Figure 5-6 An example image of one-pixel dots and its FFT**

Рисунок 5-6 (б) представляет собой двоичное изображение полученное с помощью FFT по изображению 5-6 (а). Это пороговое значение для фильтрации ненужной информации, но небольшая сетка, которая состоит из девяти точек в середине. Относительное положение девяти точек говорит нам, нужна ли коррекция поворота для исходного изображения [29]. Этот шаг необходим для снижения вероятности возникновения ошибок при декодировании. Если исходное изображение наклонено, 9-точечная сетка будет выглядеть как параллелограмм, а не прямоугольник. Угол для коррекции равен углу наклона параллелограмма.

Затем центры точек на изображении делятся на столбцы и строки. Если на изображении M × N точек, то координаты центров записываются в две матрицы M × N, одну для x-координат, а другую для y-координат.

Что касается x-координат, то из относительных положений внутри одного столбца точки можно разделить на 3 вида: левый (L), средний (M) и правый (R), в зависимости от того, в каком направлении смещена точка в х размерности. Если количество точек относительно велико, есть большая вероятность, что все три вида точек можно найти в одном столбце. Но если количество точек относительно мало, например, всего 6 ~ 10 точек на столбец, есть большая вероятность, что в столбце можно найти только два вида точек (L и M или M и R). Иногда возникает экстремальная ситуация, когда в одном столбце находится только один вид точек. К счастью, эти три ситуации можно легко идентифицировать, сравнивая ширину каждого столбца со средним значением самих по себе.

В данном варианте, если ширина столбца больше 2/3 от среднего значения, то столбец содержит все три вида точек. Если ширина меньше 1/3 среднего значения, то столбец, вероятно, имеет только один вид точек. И если ширина столбца составляет от 1/3 до 2/3 от среднего значения, то столбец должен иметь 2 вида точек.

Легко узнать, в каком направлении смещены точки для первого типа столбцов. Поскольку все, что нам нужно сделать, это еще больше разделить точки в столбце на три вида. Наименьшая 1/3 - левые, средняя - 1/3 средних, наибольшая - 1/3 правых.

Все становится более сложным, когда дело доходит до последних двух видов столбцов. Решение, которое мы даем, состоит в том, чтобы принять во внимание другие координаты, основываясь на свойстве, которое имеет Anoto Dot Pattern. Мы знаем, что всего существует четыре направления, в которых точки могут быть смещены: два в измерении x, два других в измерении y. И мы назначаем указатель поворота в виде списка в таблице ниже:

**Table 5-1 Conversion between offset direction and offset indicators**

| Offset  direction | Indicator in x | Indicator in y |
| :---------------: | :------------: | :------------: |
|                   |   dimension    |   dimension    |
|       Left        |       -1       |       0        |
|       Right       |       1        |       0        |
|        Up         |       0        |       1        |
|       Down        |       0        |       -1       |

Как видно из таблицы 5-1, один из двух индикаторов должен быть равен 0, но они не могут быть равны 0 одновременно. Это свойство полезно, поскольку, если мы не можем определить направление смещения точки в одном измерении, мы можем искать в другом измерении. Обычно проблема будет решена.

Как только направление смещения каждой точки определено, важно убедиться, что оно правильное. Так как качество печати или изображения может быть низким и изображение может быть искажено. Точки, полученные с помощью описанных выше процедур, могут не располагаться точно там, где они должны быть.

После раздела исправления ошибок мы можем декодировать точечные шаблоны в коды как в направлении x, так и в направлении y, как показано в таблице 4-1. И затем мы можем использовать коды x и y, следуя указаниям, указанным в главе 4, чтобы определить координаты столбцов и строк. Пример процесса приведен ниже. Предварительно обработанное двоичное изображение показано на рисунке 5-7.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image011.jpg)

​								 **Figure 5-7 Подготовленное для декодирования изображение**

Первое, что нам нужно сделать, это проверить, не наклонен ли точечный шаблон, содержащийся в этом изображении. Если это не так, то виртуальные растровые линии должны быть параллельны координатной оси. И это то, что мы хотим. В противном случае мы должны выяснить, насколько он наклонен, и повернуть изображение в противоположном направлении, чтобы отменить эффект. Конечно, иногда нелегко судить о том, наклонено ли изображение и нуждается ли оно в коррекции поворота человеческим глазом, поскольку угол наклона может быть относительно небольшим. Но мы можем использовать преобразование Фурье, обычно быстрое преобразование Фурье изображения, и решить эту проблему в частотной области. БПФ на рисунке 5-7 показано на рисунке 5-8 (а) ниже.

Прежде чем использовать его, устанавливается пороговое значение для фильтрации ненужной информации. Этот процесс необходимо выполнить вручную, чтобы убедиться, что вся информация, кроме девяти точек в середине изображения, отфильтрована. Эти девять точек образуют небольшой параллелограмм. Угол, образованный сторонами параллелограмма, а также горизонтальным и вертикальным направлениями, указывает, параллельны ли виртуальные растровые линии оси координат.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image013.jpg)

 **Figure 5-8 Using FFT of the one-pixel dots image to correct the incline**

3. 

Поскольку 9-точечный параллелограмм состоит из 4 меньших параллелограммов, мы можем для простоты взглянуть на меньшие параллелограммы. В соответствии с геометрическими соотношениями этих точек расчеты производятся следующим образом:

  1. Найдите центральную точку, и ее координата получится как Pc (257,00, 257,00).

2. Найдите четыре ближайшие точки к центральной точке во всех квадрантах. Это делается путем поиска точки, которая имеет наименьшее евклидово расстояние до центральной точки во всех четырех квадрантах. И это P1 (257,33, 269,33), P2 (244,67, 257,33), P3 (256,67, 244,67) и P4 (269,33, 256,67).

3. Определите четыре уклона прямых линий P1Pc, P2Pc, P3Pc и P4Pc. Результат показан в таблице 4-2.

**Table 5-2 Calculation of the incline angle**

|       | *P*1*P*c | *P*2*P*c | *P*3*P*c | *P*4*P*c |
| ----- | -------- | -------- | -------- | -------- |
| Slope | 0.9996   | 0.0270   | 0.9996   | 0.0270   |
| Angle | 88.45º   | 1.55º    | 88.45º   | 1.55º    |

Проанализируйте углы в Таблице 5-2, и обнаружите, что точечный рисунок наклонен на 1,55 градуса. Поверните исходное изображение на -1,55 градуса для коррекции поворота. Исправленное изображение показано на рисунке 5-9.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image014.jpg)

 **Figure 5-9 The incline-corrected image**

Затем нужно вычислить координаты центров всех точек, как показано в таблице 5-3:

**Table 5-3 x, y coordinates (in pixels) of the centroids (a) the x coordinates (b) the y coordinates**

(a) the x coordinates

![img](file:////Users/mor1ins/projects/diploma/img/clip_image015.jpg)

 b) the y coordinates

![img](file:////Users/mor1ins/projects/diploma/img/clip_image016.jpg)

Используйте первый столбец в качестве примера. Минимальное значение координат х составляет 19,5740, а максимальное значение координат х составляет 33,0250. Таким образом, разница этих двух составляет ∆1 = 33.0250-19.5740 = 13.4510. Мы можем рассчитать разницу максимума и минимума для каждого столбца. Результат показан в таблице 5-4.

 **Table 5-4 Differences of maximum and minimum of each column**

|   Column   |   ∆1    | ∆2      | ∆3      | ∆4      | ∆5     | ∆6      | ∆7     | ∆8      |
| :--------: | :-----: | ------- | ------- | ------- | ------ | ------- | ------ | ------- |
| Difference | 13.4510 | 13.3054 | 13.2591 | 11.9402 | 9.6412 | 15.5719 | 7.4694 | 10.2475 |

Следовательно, максимальная разница составляет 15,5719.

1/3 максимальной разницы: 5.1906

2/3 максимальной разницы: 10,3813

Столбцы с разницей больше 10,3813 (класс столбца A): столбец 1, столбец 2, столбец 3, столбец 4 и столбец 6

Столбцы с разницей между 5.1906 и 10.3813 (класс столбца B): столбец 5, столбец 7 и столбец 8.

Что касается столбцов в классе A, существует три вида точек (учитывая только в направлении х, поэтому точки, которые смещаются вверх и вниз, считаются одним «средним»). Опять же, возьмем первый столбец в качестве примера, разделим расстояние между точкой с минимальной координатой x и точкой с максимальной координатой x на три интервала одинаковой длины в направлении x: [19.5740, 24.0577), [24.0577, 28.5414) и [28.5414, 33.0250]. Присвойте индикатор смещения «-1» точкам, координата x которых попадает в первый интервал (левые), «0» точкам, координата x которых попадает во второй интервал (средние), и «1» точкам, чья Координата х попадает в последний интервал.

Что касается столбцов в классе B, есть только две возможные комбинации направлений смещения для точек - левые и средние или средние и правые. В этой ситуации мы можем сначала разделить расстояние между точкой с минимальной координатой x и точкой с максимальной координатой x на два интервала одинаковой длины. Возьмем, к примеру, пятый столбец массива, интервалы которого равны [191.2804, 196.1010) и [196.1010, 200.9216]. Присвойте индикатор смещения «-2» точкам, координата x которых находится в первом интервале, а индикатор смещения «2» точкам, координата x которых находится во втором интервале. Затем получаются указатели направления смещения, которые показаны в таблице 5-5.

**Table 5-5 Unmatched Offset direction indicators in x, y directions (a) in the x direction and (b) in the y direction**

(a) in the x direction

![img](file:////Users/mor1ins/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image017.jpg)

(b) in the y direction

![img](file:////Users/mor1ins/projects/diploma/img/clip_image018.jpg)

Индикаторы смещения «-2» и «2» являются только временными. Они не указывают фактическое направление смещения точек, а просто указывают отношение положения внутри столбца. Чтобы узнать фактическое направление смещения, нам нужно учесть индикатор смещения в направлении y, как показано в таблице 5-5 (b). Легко обнаружить, что общая черта столбцов с «2» и «-2» заключается в том, что в этом столбце нет «0».

Теперь сфокусируйтесь на индикаторе смещения столбца 2 в направлении y. Это -1, 2, -1, 1, -1, 1, 2, 0. Вместе с теми в направлении х, они делятся на пары как (-2, -1), (-2,2), ( -2, -1), (-2,1), (-2, -1), (-2,1), (-2,2), (2,0). Мы знаем, что индикаторы смещения в направлении x и y не должны быть одновременно 0, но хотя бы один из них должен быть 0. Таким образом, пары факторов улучшены до (0, -1), (-2, 2), ( 0, -1), (0,1), (0, -1), (0,1), (-2, 2), (2, 0). Затем мы получаем вывод, что во втором столбце индикатор смещения «-2» фактически равен «0», и поэтому индикатор смещения «2» должен быть «1».

Кроме того, обратите внимание, что последняя пара равна (2,0), поскольку «2» указывает, что точка находится в относительно правой половине распределения точек, а ее аналог в направлении y уже равен «0», поэтому она должна быть «1». , Это согласуется с приведенным выше выводом. Наконец, индикатор смещения для пятого столбца в направлении x должен быть: 0, 0, 0, 0, 0, 0, 0, 1. Аналогичный процесс выполняется для двух других столбцов. Обновленные результаты всех столбцов показаны в таблице 5-6 (а). Процесс для направления y аналогичен, и результаты показаны в Таблице 5-6 (b). Весь процесс похож на проблему судоку, но намного проще.

**Table 5-6 Offset direction indicators after first correction (a) in the x direction and (b) in the y direction**

 (a) in the x direction

![img](file:////Users/mor1ins/projects/diploma/img/clip_image019.jpg)

 (b) in y direction

![img](file:////Users/mor1ins/projects/diploma/img/clip_image020.jpg)

Однако индикаторы смещения окончательно не проверены. Как видно из Таблицы 5-6 (a) и (b), пары индикаторов в {1,1}, {3,3} и {1,8} равны (-1,1), (-1, 1) и (0, 0) соответственно ({* L *, * M *} означает строку * L ** th * и столбец * M ** th *). Эти пары индикаторов не могут создать правильный x-код и y-код. Решением этого тезиса является реконструкция виртуальных растровых линий [23].

Как только индикаторы смещения получены для обоих направлений x и y, становится легко установить виртуальные растровые линии. Точечный рисунок с растровыми линиями показан на рисунке 5-10.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image022.jpg)

**The dot pattern with reconstructed visible raster lines**

Поскольку растровые линии получаются через положения точек, которые, возможно, были искажены во время обработки, растровые линии могут располагаться не одинаково. Однако с помощью растровых линий направления смещения каждой точки становятся четкими. И это дополнительный способ убедиться, что индикатор смещения получен правильно. Возьмем пару индикаторов, например, {1,1}.

Расстояние между точкой и растровой линией в направлении х:

Dx = 23,8882 - 25,7418 = -1,8536;

Расстояние между точкой и растровой линией в направлении y:

Dy = 321,3851 - 315,8861 = 5,4990;

А для абсолютного значения abs (Dy)> abs (Dx).

Таким образом, направление смещения определяется как направление y. Индикатору присваивается «1» со знаком, определяемым знаком Dy. Поэтому пары индикаторов на {1,1} были скорректированы с (-1,1) до (0,1).

**Table 5-7 Final offset direction indicators (a) in the x direction and (b) in the y direction**

**(a) in the x direction**

![img](file:////Users/mor1ins/projects/diploma/img/clip_image023.jpg)

 **(b) in the y direction**

![img](file:////Users/mor1ins/projects/diploma/img/clip_image024.jpg)

Коды x, y затем получают путем преобразования пар индикаторов через биекцию, показанную в таблице 4-1. Результаты показаны в таблице 5-9:

**Table 5-8 Corresponding x, y codes**

![img](file:////Users/mor1ins/projects/diploma/img/clip_image026.jpg)

Для направления x из таблицы 5-5 (a) шесть вертикальных частичных последовательностей получаются следующим образом: 00110101, 01001000, 10011010, 10010000, 10101000, 10000111, 10100100 и 10001110. Соответствующие места этих частичных последовательностей в основном номере последовательности

  47, 14, 46, 15, 32, 18, 13, 57.

Первичная разностная последовательность дополнительно получается как

  30, 32, 32, 17, 49, 58, 44.

Вторичные разностные последовательности получены с использованием таблицы 5-9:

**Table 5-9 An example of converting primary difference number sequence into secondary difference number sequences**

| d    | 30   | 32   | 32   | 17   | 49   | 58   | 44   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| a1   | 1    | 0    | 0    | 0    | 2    | 2    | 0    |
| a2   | 2    | 0    | 0    | 1    | 2    | 2    | 1    |
| a3   | 0    | 1    | 1    | 1    | 0    | 1    | 0    |
| a4   | 1    | 1    | 1    | 0    | 2    | 2    | 2    |

Четырьмя частичными последовательностями длиной 5 являются «10002» для A1, «20012» для A2, «01110» для A3, «11102» для A4. Соответствующие номера мест указаны ниже:

  p1 = 119

  р2 = 147

  р3 = 25

  р4 = 178

  Пока номер сечения в направлении x известен или четыре таких числа для первого массива 8 × 8 точечного шаблона получены, мы можем назначить координату столбца.

  Для первого массива 8 × 8 p1-p4 получаются как

  p1 = 32

  p2 = 57

  р3 = 12

  р4 = 96

Поскольку значения p1-p4 увеличиваются на единицу подряд, когда область интереса перемещается на один столбец вправо, можно создать бесконечную таблицу, как показано ниже:

 **Table 5-10 The relation between column number and the four place numbers**

|      | Column 1 | Column 2 | Column 3 | …    | Column  x | …    |
| ---- | -------- | -------- | -------- | ---- | --------- | ---- |
| p1   | 32       | 33       | 34       | …    | 119       | …    |
| p2   | 57       | 58       | 59       | …    | 147       | …    |
| p3   | 12       | 13       | 14       | …    | 25        | …    |
| p4   | 96       | 97       | 98       | …    | 178       | …    |

Диапазоны p1, p2, p3 и p4 составляют от 0 до 235, от 0 до 232, от 0 до 30 и от 0 до 240 соответственно. Одинаковые комбинации p1, p2, p3 и p4 встречаются каждые l1 × l2 × l3 × l4 = 236 ×

233 × 31 × 241 = 410815348 столбцов. Это 410815348 × 0,3 мм = 123244604,4 мм = 123,2 км, что намного больше, чем размер тестовых работ, использованных в этой диссертации.

При просмотре таблицы 5-10, которая устанавливается с использованием Matlab, столбец, соответствующий (119, 147, 25, 178), оказывается столбцом 324, что означает, что первый столбец массива 8 × 8 является столбцом 324 всей поверхности. Таким образом, последний столбец массива 8 × 8 - это столбец 331.

Аналогичный процесс сделан для направления y. Вместо использования вертикальных частичных последовательностей в таблице 5-5 используются горизонтальные частичные последовательности. Это 00001110, 1000001, 11001010, 01110111, 11101001, 10110011, 11000000 и 11011100. Номера мест во вторичных разностных последовательностях равны (50, 87, 11, 207). И номера мест для первой строки точечного рисунка равны (224, 19, 4, 155), затем получается таблица, аналогичная таблице 5-10, для направления у, показанного в таблице 5-11.

**Table 5-11 The relation between row number and the four place numbers**



|       | p1   | p2   | p3   | p4   |
| ----- | ---- | ---- | ---- | ---- |
| Row 1 | 224  | 19   | 4    | 155  |
| Row 2 | 225  | 20   | 5    | 156  |
| Row 3 | 226  | 21   | 6    | 157  |
| …     | …    | …    | …    | …    |
| Row y | 50   | 87   | 11   | 207  |
| …     | …    | …    | …    | …    |

Посмотрев таблицу 5-11, координата строки, соответствующая (50, 87, 11, 207), равна строке 535. Таким образом, строки, включенные в представляющий интерес массив 8 × 8, представляют собой строки 535 - строки 542. Декодирование завершено и успешно.

**5-4 Calculate the movement distance** 

С помощью любого массива 6 × 6 или 8 × 8 массива точек, который успешно декодируется, мы можем быстро получить точную информацию о положении интересующего нас объекта на оцифрованной поверхности, просто фотографируя интересующую область [ 30,31]. Если мы записываем информацию о положении объекта в первой позиции и информацию об объекте во второй позиции, то расстояние, на которое объект переместился из первой позиции во вторую.

В качестве примера мы можем рассмотреть случай, когда информация о положении массива фоновых точек известна. Это показано на рисунке 5-11. Это может быть немного непрактично, поскольку предполагает, что изображение берется до и после объекта на странице, но в принципе показывает, как метод может быть использован. Однако в случае ручки, в которой точки являются отражающими в инфракрасном диапазоне, а чернила из ручки прозрачны для инфракрасного, этот метод должен работать. В обоих случаях - как продолжение этого - если поле зрения достаточно широкое и до тех пор, пока один 8 × 8 может использоваться для получения абсолютной координаты, эта информация может использоваться для экстраполяции информации о скрытых точках. Эта информация может быть использована для вычитания точек из изображения.

![img](file:////Users/mor1ins/projects/diploma/img/clip_image028.jpg)

​																	(a)                    (b)                     (c)

**Figure 5-11 (a) the preprocessed image of the region of interest, with the object (the circle) at its starting position (b) the known dot pattern of the background, which will provide the position of the region (c) extracted from (a), which is a binary image of the object with the position relation unchanged from (a). 60****×** **magnification.**

Поскольку мы уже знаем положение массива 8 × 8 во всем точечном паттерне, нам нужно найти объект в массиве. Это может быть упрощено, чтобы найти центр тяжести объекта в массиве. Это сделано как показано ниже.

1. Получить координаты в пикселях центра тяжести объекта на изображении. В этом примере

это * P * o (238,7545, 224,2730).

2. Сравните координату точки * P * o с растровыми линиями. И можно обнаружить, что точка расположена между 6-м столбцом и 7-м столбцом, 3-й строкой и 4-й строкой.

3. Добавьте десятичную часть к местоположению точки, чтобы указать ее точную координату в столбцах и строках.

  Координата 6-го столбца: х = 234,1396;

  Координата 7-го столбца х = 279,4906;

  Координата 3-й строки: y = 230.8409.

  Координата 4-й строки: y = 192.1063.

  Object_Column = (238,7545 - 234,1396) / (279,4906-238,7545) +6 = 6,1018;

  Object_Row = (224.2730-230.8469) / (192.1063-230.8469) +3 = 3,1696.

4. Координаты столбца и строки центроида в точечном растре получают как: C = 6.1018 + 324 -1 = 329.1018;

R = 3,1696 +535 -1 = 537,1696.

Тот же процесс можно выполнить, когда объект переместился в свою конечную позицию. И тогда мы можем получить другую координату его центроида, координату в конечной позиции. Если это значение (923.2411, 345.5511), то, используя базовые знания векторной и евклидовой геометрии, мы можем рассчитать расстояние, на которое перемещается объект, следующим образом:
$$
Distance = sqrt((923.2411 - 329.1018)^2 + (345.5511 - 537.1696)^2)
$$
Это основано на расстоянии сетки в направлении х и в направлении у, которые равны, что, конечно, не является действительно необходимым. Тогда, как мы знаем заранее, расстояние сетки в обоих направлениях составляет 0,3 мм, таким образом, расстояние 624,27 × 0,3 мм = 187,3 мм.